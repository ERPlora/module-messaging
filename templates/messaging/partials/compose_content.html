{% load djicons i18n %}
<div data-back-url="{% url 'messaging:messages' %}" hidden></div>

<div class="p-4">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-6">
        <div class="flex-1">
            <h1 class="text-2xl font-bold">{% trans "Compose Message" %}</h1>
            <p class="text-sm text-base-content/60 mt-1">{% trans "Send a message to a customer via WhatsApp, SMS, or email" %}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Compose Form -->
        <div class="lg:col-span-2">
            <div class="card">
                <form hx-post="{% url 'messaging:send_message' %}"
                      hx-target="#main-content-area"
                      hx-swap="innerHTML"
                      x-data="{ channel: '{{ form.channel.value|default:'email' }}' }">
                    {% csrf_token %}
                    <div class="card-body">
                        <!-- Channel -->
                        <div class="form-group mb-4">
                            <label class="form-group-label">{% trans "Channel" %}</label>
                            {{ form.channel }}
                        </div>

                        <!-- Recipient -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="form-group">
                                <label class="form-group-label">{% trans "Recipient Name" %}</label>
                                {{ form.recipient_name }}
                            </div>
                            <div class="form-group">
                                <label class="form-group-label">{% trans "Contact" %}</label>
                                {{ form.recipient_contact }}
                            </div>
                        </div>

                        <!-- Subject (email only) -->
                        <div class="form-group mb-4">
                            <label class="form-group-label">{% trans "Subject" %}</label>
                            {{ form.subject }}
                        </div>

                        <!-- Template selection -->
                        <div class="form-group mb-4">
                            <label class="form-group-label">{% trans "Template (optional)" %}</label>
                            {{ form.template }}
                        </div>

                        <!-- Body -->
                        <div class="form-group mb-4">
                            <label class="form-group-label">{% trans "Message" %}</label>
                            {{ form.body }}
                        </div>
                    </div>
                    <div class="card-body border-t border-base-200 flex justify-end gap-2">
                        <button type="button" class="btn btn-ghost"
                                hx-get="{% url 'messaging:messages' %}"
                                hx-target="#main-content-area"
                                hx-push-url="true">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" class="btn color-primary">
                            {% icon "send-outline" %}
                            {% trans "Send Message" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Sidebar -->
        <div class="lg:col-span-1">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{% icon "help-circle-outline" css_class="text-primary" %} {% trans "Variables" %}</h3>
                </div>
                <div class="card-body">
                    <p class="text-sm text-base-content/60 mb-3">{% trans "Use these variables in your message:" %}</p>
                    <div class="space-y-2">
                        {% verbatim %}
                        <code class="text-xs bg-base-200 px-2 py-1 rounded block">{{customer_name}}</code>
                        <code class="text-xs bg-base-200 px-2 py-1 rounded block">{{business_name}}</code>
                        <code class="text-xs bg-base-200 px-2 py-1 rounded block">{{appointment_date}}</code>
                        <code class="text-xs bg-base-200 px-2 py-1 rounded block">{{appointment_time}}</code>
                        <code class="text-xs bg-base-200 px-2 py-1 rounded block">{{service_name}}</code>
                        <code class="text-xs bg-base-200 px-2 py-1 rounded block">{{total_amount}}</code>
                        {% endverbatim %}
                    </div>
                </div>
            </div>

            {% if templates %}
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">{% icon "document-text-outline" css_class="text-primary" %} {% trans "Available Templates" %}</h3>
                </div>
                <div class="card-body p-0">
                    <div class="list">
                        {% for tmpl in templates %}
                        <div class="list-item">
                            <div class="list-item-content">
                                <div class="list-item-label">{{ tmpl.name }}</div>
                                <div class="list-item-note">{{ tmpl.get_category_display }} - {{ tmpl.get_channel_display }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
